datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}

model User {
  id        Int       @id @default(autoincrement())
  utorid    String    @unique
  name      String
  email     String    @unique
  password  String?
  role      RoleType  @default(regular)
  points    Int       @default(0)
  birthday  String?

  createdAt DateTime  @default(now())
  lastLogin DateTime?

  verified   Boolean  @default(false)
  activated  Boolean  @default(false)
  suspicious Boolean  @default(false)

  avatarUrl String?

  resetToken    String?
  resetTokenExp DateTime?

  createdTransactions Transaction[] @relation("creator")
  transactions        Transaction[] @relation("owner")

  organizedEvents Organizer[]
  guestEvents     Guest[]
  promotionUses   PromotionUser[]

  processedTransactions Transaction[] @relation("processed_by")
}

model Transaction {
  id        Int              @id @default(autoincrement())
  type      TransactionType
  remark    String?

  spent     Float?
  amount    Int?
  redeemed  Int?

  processed   Boolean @default(false)
  processedBy Int?
  processedByUser User? @relation("processed_by", fields: [processedBy], references: [id])

  relatedId Int?

  suspicious Boolean @default(false)

  ownerId Int
  owner   User @relation("owner", fields: [ownerId], references: [id])

  createdBy Int?
  creator   User? @relation("creator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())

  promotionLinks TransactionPromotion[] @relation("TransactionToPromotion")
}


model Event {
  id            Int       @id @default(autoincrement())
  name          String
  description   String
  location      String
  startTime     DateTime
  endTime       DateTime
  capacity      Int?

  points        Int
  pointsRemain  Int
  pointsAwarded Int @default(0)

  published Boolean @default(false)

  organizers Organizer[]
  guests     Guest[]

  @@index([startTime])
}

model Organizer {
  id      Int   @id @default(autoincrement())
  userId  Int
  eventId Int

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

model Guest {
  id      Int   @id @default(autoincrement())
  userId  Int
  eventId Int

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

model Promotion {
  id          Int    @id @default(autoincrement())
  name        String
  description String
  type        PromotionType

  startTime DateTime
  endTime   DateTime

  minSpending Float?
  rate        Float?
  points      Int?

  promotionUsers PromotionUser[]
  transactionLinks TransactionPromotion[] @relation("PromotionToTransaction")
}

model TransactionPromotion {
  id            Int @id @default(autoincrement())
  transactionId Int
  promotionId   Int

  transaction Transaction @relation("TransactionToPromotion", fields: [transactionId], references: [id])
  promotion   Promotion   @relation("PromotionToTransaction", fields: [promotionId], references: [id])

  @@unique([transactionId, promotionId])
}

model PromotionUser {
  id       Int    @id @default(autoincrement())
  used     Boolean @default(false)

  promotionId Int
  userId      Int

  promotion Promotion @relation(fields: [promotionId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([promotionId, userId])
}
